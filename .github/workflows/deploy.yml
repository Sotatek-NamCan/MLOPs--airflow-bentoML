name: Deploy BentoML to EC2 (pull model.pkl from S3)

on:
  push:
    branches: ["main"]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: SSH deploy on EC2
        uses: appleboy/ssh-action@v1.1.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: ${{ secrets.EC2_PORT }}
          script_stop: true
          script: |
            set -euo pipefail

            APP_DIR="${{ secrets.EC2_APP_DIR }}"                 # e.g. /opt/bento-app
            MODEL_META_FILE="${{ secrets.MODEL_META_FILE }}"     # e.g. /opt/bento-app/model.yaml
            S3_PREFIX="${{ secrets.MODEL_S3_PREFIX }}"           # e.g. s3://my-bucket/artifacts

            echo "==> Go to app dir: $APP_DIR"
            cd "$APP_DIR"

            # ----- Parse simple YAML: key: "value" -----
            get_yaml_value() {
              local key="$1"
              # expects format: key: "value"
              awk -F': ' -v k="$key" '
                $1==k {
                  v=$2
                  gsub(/^[ \t]+|[ \t]+$/, "", v)
                  gsub(/"/, "", v)
                  print v
                  exit
                }
              ' "$MODEL_META_FILE"
            }

            MODEL_PATH="$(get_yaml_value 'model-path')"          # e.g. models/my_model

            if [ -z "${MODEL_PATH:-}" ]; then
              echo "ERROR: model-path is empty or not found in $MODEL_META_FILE"
              exit 1
            fi

            # Build S3 URI from model-path (+ optional version)
            # Option A (default below): s3://.../<model-path>/<model-version>/model.pkl (if version exists)
            # If bạn KHÔNG muốn kèm version, chỉ cần bỏ khối if MODEL_VERSION.
            S3_URI="${S3_PREFIX%/}/${MODEL_PATH#/}"
            
            echo "==> Using S3 URI: $S3_URI"

            mkdir -p tmp models

            echo "==> Download model.pkl from S3"
            aws s3 cp "$S3_URI" "tmp/model.pkl"

            echo "==> Verify model file"
            ls -lah tmp/model.pkl

            mv -f "./tmp/model.pkl" "./models/model.pkl"

            sudo systemctl restart model
            sudo systemctl status model --no-pager

            echo "==> Done"
