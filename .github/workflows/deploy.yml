name: Deploy BentoML to EC2 (pull model.pkl from S3)

on:
  push:
    branches: ["main"]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1) Setup SSH key (from secrets)
      - name: Setup SSH agent
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh

          eval "$(ssh-agent -s)"
          # Add private key (PEM) from secret
          ssh-add - <<< "${{ secrets.EC2_SSH_KEY }}"

          # Add EC2 host key to known_hosts to avoid interactive prompt
          ssh-keyscan -p "${{ secrets.EC2_PORT }}" -H "${{ secrets.EC2_HOST }}" >> ~/.ssh/known_hosts
          chmod 600 ~/.ssh/known_hosts

      # 2) Deploy via SSH (run remote script)
      - name: SSH deploy on EC2
        shell: bash
        run: |
          set -euo pipefail

          ssh -p "${{ secrets.EC2_PORT }}" \
              -o StrictHostKeyChecking=yes \
              "${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}" \
              'bash -s' <<'REMOTE_SCRIPT'
          set -euo pipefail

          APP_DIR="${EC2_APP_DIR}"
          MODEL_META_FILE="${MODEL_META_FILE}"
          S3_PREFIX="${MODEL_S3_PREFIX}"

          echo "==> Go to app dir: $APP_DIR"
          cd "$APP_DIR"

          get_yaml_value() {
            local key="$1"
            awk -F': ' -v k="$key" '
              $1==k {
                v=$2
                gsub(/^[ \t]+|[ \t]+$/, "", v)
                gsub(/"/, "", v)
                print v
                exit
              }
            ' "$MODEL_META_FILE"
          }

          MODEL_PATH="$(get_yaml_value 'model-path')"

          if [ -z "${MODEL_PATH:-}" ]; then
            echo "ERROR: model-path is empty or not found in $MODEL_META_FILE"
            exit 1
          fi

          # model-path already includes filename
          S3_URI="${S3_PREFIX%/}/${MODEL_PATH#/}"

          echo "==> Using S3 URI: $S3_URI"

          mkdir -p tmp models

          echo "==> Download model artifact from S3"
          aws s3 cp "$S3_URI" "tmp/model.pkl"

          echo "==> Verify model file"
          ls -lah tmp/model.pkl

          mv -f "./tmp/model.pkl" "./models/model.pkl"

          sudo systemctl restart model
          sudo systemctl status model --no-pager

          echo "==> Done"
REMOTE_SCRIPT
        env:
          # pass secrets into the remote script as env vars
          EC2_APP_DIR: ${{ secrets.EC2_APP_DIR }}
          MODEL_META_FILE: ${{ secrets.MODEL_META_FILE }}
          MODEL_S3_PREFIX: ${{ secrets.MODEL_S3_PREFIX }}
