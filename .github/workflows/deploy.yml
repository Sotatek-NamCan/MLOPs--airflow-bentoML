name: Bento Import and Serve

on:
  workflow_dispatch:
    inputs:
      remote_dir:
        description: Path to the bento_service folder on the instance
        required: false
        default: /home/ec2-user/MLOPs--airflow-bentoML/bento_service
      repo_dir:
        description: Path to the repo root on the instance (used for git pull)
        required: false
        default: /home/ec2-user/MLOPs--airflow-bentoML
      model_name:
        description: Bento model name
        required: false
        default: model
      model_version:
        description: Bento model version (use "latest" to auto-tag)
        required: false
        default: latest
      bento_tag:
        description: "Bento tag used for containerize/run (ex: driver_prediction_service:latest)"
        required: false
        default: driver_prediction_service:latest
      serve_port:
        description: Port for BentoML HTTP server
        required: false
        default: "3000"
      ssh_port:
        description: SSH port for the instance
        required: false
        default: "22"

jobs:
  deploy-bento:
    runs-on: ubuntu-latest
    steps:
      - name: SSH import/build/serve
        uses: appleboy/ssh-action@v1.0.3
        env:
          REPO_DIR: ${{ inputs.repo_dir }}
          REMOTE_DIR: ${{ inputs.remote_dir }}
          S3_URI: ${{ secrets.MODEL_S3_PREFIX }}
          MODEL_NAME: ${{ inputs.model_name }}
          MODEL_VERSION: ${{ inputs.model_version }}
          BENTO_TAG: ${{ inputs.bento_tag }}
          SERVE_PORT: ${{ inputs.serve_port }}
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: ${{ inputs.ssh_port }}
          envs: REPO_DIR,REMOTE_DIR,S3_URI,MODEL_NAME,MODEL_VERSION,BENTO_TAG,SERVE_PORT
          script: |
            set -euo pipefail
            cd "${REPO_DIR}"
            git pull --ff-only
            cd "${REMOTE_DIR}"

            if [ ! -f "import_model_from_s3.py" ]; then
              echo "import_model_from_s3.py not found in ${REMOTE_DIR}"
              exit 1
            fi
            if [ ! -f ".envbento" ]; then
              echo ".envbento not found in ${REMOTE_DIR}"
              exit 1
            fi

            if [ ! -d ".venv" ]; then
              python3 -m venv .venv
            fi
            . .venv/bin/activate
            pip install -r requirements.txt

            python import_model_from_s3.py \
              --s3-uri "${S3_URI}" \
              --model-name "${MODEL_NAME}" \
              --model-version "${MODEL_VERSION}"

            export BENTOML_MODEL_TAG="${MODEL_NAME}:${MODEL_VERSION}"
            bentoml build -t "${BENTO_TAG}"
            bentoml containerize "${BENTO_TAG}"
            docker run -d --name bento_service -p "${SERVE_PORT}:3000" \
              -e BENTOML_MODEL_TAG="${MODEL_NAME}:${MODEL_VERSION}" \
              "${BENTO_TAG}"
            echo "BentoML container started on port ${SERVE_PORT}"
