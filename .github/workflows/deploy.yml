name: Deploy BentoML to EC2 (pull model artifact from S3)

on:
  push:
    branches: ["main"]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy on EC2
        shell: bash
        env:
          EC2_APP_DIR: ${{ secrets.EC2_APP_DIR }}           # e.g. /opt/bento-app
          MODEL_META_FILE: ${{ secrets.MODEL_META_FILE }}   # e.g. /opt/bento-app/model.yaml
          MODEL_S3_PREFIX: ${{ secrets.MODEL_S3_PREFIX }}   # e.g. s3://my-bucket/artifacts
        run: |
          set -euo pipefail

          # --- SSH key + known_hosts (simple, no ssh-agent) ---
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh

          echo "${{ secrets.EC2_SSH_KEY }}" | tr -d '\r' > ~/.ssh/ec2_key
          chmod 600 ~/.ssh/ec2_key

          ssh-keyscan -p "${{ secrets.EC2_PORT }}" -H "${{ secrets.EC2_HOST }}" >> ~/.ssh/known_hosts
          chmod 600 ~/.ssh/known_hosts

          # --- Run remote deploy script ---
          ssh -i ~/.ssh/ec2_key \
            -p "${{ secrets.EC2_PORT }}" \
            -o StrictHostKeyChecking=yes \
            "${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}" \
            "EC2_APP_DIR='${EC2_APP_DIR}' MODEL_META_FILE='${MODEL_META_FILE}' MODEL_S3_PREFIX='${MODEL_S3_PREFIX}' bash -s" <<'REMOTE_SCRIPT'
          set -euo pipefail

          APP_DIR="${EC2_APP_DIR}"
          META_FILE="${MODEL_META_FILE}"
          S3_PREFIX="${MODEL_S3_PREFIX}"

          echo "==> APP_DIR: ${APP_DIR}"
          cd "${APP_DIR}"

          # Read: model-path: "models/.../model.pkl"
          MODEL_PATH="$(
            awk '
              $0 ~ /^[[:space:]]*model-path[[:space:]]*:/ {
                sub(/^[[:space:]]*model-path[[:space:]]*:[[:space:]]*/, "", $0)
                gsub(/^[ \t]+|[ \t]+$/, "", $0)
                gsub(/^["'\''"]|["'\''"]$/, "", $0)
                print; exit
              }
            ' "$META_FILE"
          )"

          if [ -z "${MODEL_PATH:-}" ]; then
            echo "ERROR: model-path is empty or not found in ${META_FILE}"
            exit 1
          fi

          S3_URI="${S3_PREFIX%/}/${MODEL_PATH#/}"
          echo "==> Using S3 URI: ${S3_URI}"

          mkdir -p models
          aws s3 cp "${S3_URI}" "models/model.pkl"
          ls -lah models/model.pkl

          sudo systemctl restart model
          sudo systemctl status model --no-pager
          echo "==> Done"
          REMOTE_SCRIPT
